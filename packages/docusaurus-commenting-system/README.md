# Docusaurus commenting system plugin

The Docusaurus Commenting System plugin allows to add a realtime commenting system to your Docusaurus project. It uses Supabase as a backend and GitHub as an authentication provider.

## Installation

### Supabase setup

1. Create a Supabase project.
2. Activate the GitHub authentication provider (Authentification > Providers).
3. In the SQL Editor, run the following queries:

   - To create the `profiles` table:

   ```sql
   create table
     public.profiles (
       id uuid not null,
       user_name text null,
       constraint profiles_pkey primary key (id),
       constraint profiles_id_fkey foreign key (id) references auth.users (id) on delete cascade
     ) tablespace pg_default;
   ```

   - To create the `comments` table:

   ```sql
   create table
     public.comments (
       id bigint generated by default as identity,
       created_at timestamp without time zone not null default now(),
       text text not null,
       page_path text not null,
       author_id uuid not null default auth.uid (),
       constraint comment_pkey primary key (id),
       constraint comment_id_key unique (id),
       constraint comments_author_id_fkey foreign key (author_id) references profiles (id)
     ) tablespace pg_default;
   ```

   - To create a function and a trigger to automatically fill the `profiles` table when a new user authenticates with GitHub for the first time:

   ```sql
   -- inserts a row into public.profiles
   create function public.handle_new_user()
   returns trigger
   language plpgsql
   security definer set search_path = public
   as $$
   begin
     insert into public.profiles (id, user_name)
     values (new.id, new.raw_user_meta_data ->> 'user_name');
     return new;
   end;


   $$;

   -- trigger the function every time a user is created
   create trigger on_auth_user_created
     after insert on auth.users
     for each row execute procedure public.handle_new_user();

   ```

4. Activate Realtime on the `comments` table.
5. Go to Database > Schema Visualizer and make sure that your database schema looks like this:
   ![Supabase database schema](https://iili.io/JRKk0v9.png)
6. Please consider adding RLS (Row Level Security) policies to your tables. You should allow only authenticated users to INSERT on the `comments` table and you can add public read access to the `profiles` and `comments` tables.

### Docusaurus setup

1. Add the plugin to your Docusaurus project: `yarn add @acid-info/docusaurus-commenting-system`.
2. Add the plugin to your `docusaurus.config.js` file:

```js
const config = {
  // other config fields...,
  plugins: [
    // other plugins...,
    [
      '@acid-info/docusaurus-commenting-system',
      {
        supabaseUrl: process.env.SUPABASE_URL,
        supabaseAnonKey: process.env.SUPABASE_ANON_KEY,
      },
    ],
  ],
}
```

3. Create a `.env` file at the root of your project and add the following environment variables. They are your Supabase Project URL and Supabase Public API Key, never put a secret key here.

```
SUPABASE_URL=https://example.supabase.co
SUPABASE_ANON_KEY=example.anon.key
```

4. Add the `CommentingSystem` component to your pages. Here is an example in a mdx docs page:

```mdx
## // docs/example.mdx

## title: Example

import { CommentingSystem } from '@acid-info/docusaurus-commenting-system/lib/client/'

# Example doc page

This is an example doc page with the commenting system at the bottom of it.

# Comments section

<CommentingSystem />
```

`N.B.:` The commenting section is unique to each individual page URL. This means that the comments you see on one page are specific to that page only and are not shared or displayed on other pages. Each page has its own separate set of comments.
